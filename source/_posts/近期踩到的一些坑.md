---
title: 近期踩到的一些坑
date: 2020-12-27 14:50:41
tags:
---
###  一.小程序http://thirdwx.qlogo.cn合法域名 

##### 场景:
笔者开发一个绘制海报图片,用户分享该海报图片分享商品功能.ios机型绘制正常,安卓绘制失败的情况

##### 开发者工具定位问题:

报 http://thirdwx.qlogo.cn 不在以下 downloadFile 合法域名列表中,原来是我绘制的海报图片中用到了微信用户头像,头像域名是http://thirdwx.qlogo.cn

##### 解决:

配置 https://thirdwx.qlogo.cn 域名 第二步:头像链接url替换:(为什么需要此步骤,原因在下面,引用至网络)

```javascript
String.prototype.replaceQLogo = function(url = 'http://thirdwx.qlogo.cn') {
  const result = this.replace(url, 'https://wx.qlogo.cn')
  return result
}


```


> canvas 里面的图片必须是本地图片不能使用网络图片，因此我们需要用到微信的一个API wx.downloadFile 将网络图片转化成本地图片，以供canvas画图时候使用，其中也明确提出需要将要下载图片的路径地址中 https 格式的域名在小程序后台进行安全域名配置。本以为万事具备，但是万万没想到正式发版以后好多用户都无法生成自己的分享图，真的是让自己严重怀疑是否写错了，可是我怎么测试都没有问题，最后几经周折发现是因为有一部分从第三方引入的用户头像是 https://thirdwx.qlogo.cn 开头的路径，时间长不使用这个功能了这就当是自己业务能力不足造成的，这个锅我背了，赶紧配置安全域名进行解决。本以为这回总没事了吧，谁成想，千算万算怎么也没算到，微信玩了一手更狠的，还有一大部分用户头像是以 http://thirdwx.qlogo.cn 开头的路径，报错信息如下，微信自己发布提供的http格式路径让存着，然后又在这里自己卡着不放报着错，真乃神操作。




### 二.passive: false

##### 问题
chrome 监听touch类事件报错：无法被动侦听事件preventDefault。阻止默认事件失效

说一下这个 preventDefault()是个什么鬼，这个是取消默认事件的，如果这个函数起作用的，比如默认的表单提交，a链接的点击跳转，就不好用了。

##### 两个解决方案：

+ 注册处理函数时，用如下方式，明确声明为不是被动的

```javascript
    window.addEventListener(‘touchmove’, function(e){
     e.preventDefault();
}, { passive: false })

```

+ 应用 CSS 属性 touch-action: none; 这样任何触摸事件都不会产生默认行为，但是 touch 事件照样触发。 touch-action 还有很多选项


### 三.swiper禁止手动滚动

翻看文档发现只有控制自动滚动的api,没有禁用手动滚动的api.第一想法是阻止事件监听,touchStart ,touchMove等事件试了一遍,发现代码复杂切效果不理想.于是想到了从css下手去解决.

于是用到了 css :pointer-events

> pointer-events CSS 属性指定在什么情况下 (如果有) 某个特定的图形元素可以成为鼠标事件的 target。

> 其中 pointer-events:none 元素永远不会成为鼠标事件的target。
 应用场景,如果页面内(或某区块)内用多个表单需同时禁用时.则可以在改表单共同父元素上使用pointer-events:none,这样所有表单无法聚焦.因此达到了禁用的目的.
 需要注意的是,当其后代元素的pointer-events属性指定其他值时，鼠标事件可以指向后代元素，在这种情况下，鼠标事件将在捕获或冒泡阶触发父元素的事件侦听器。

### 小程序scroll-view 与positive:fixed 不兼容问题

![image](https://raw.githubusercontent.com/Catcheer/d3-test/gh-pages/img/123.png)


##### 场景(如图)
+ 左边一个固定高度的scroll-view  ,右边一个scroll-view用于放product list ,ProductList是一个自定义组件,在ProductList内d弹出层用了fixed定位.可以发现弹出层仅仅显示右部分,左部分被遮盖掉.相信大多数同学都会想到调整z-index,实际上z-index是无效的.
 <span style="color:red">在微信小程序社区搜索后发现这是一个官方的bug.</span>

2. 想到的解决这个问题的两个方案

> *  1.可以scroll-view换为view(规避问题).
> *  2.弹出层部分从ProductList组件内拿出来 放到与scroll-view同一级别. 

我采用的是第二种方案